---
/* Зал славы — Juggernaut (Astro page)
   Данные грузятся из /public/data/hof.json
*/
---

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Зал славы — Juggernaut</title>

  <style>
    :root{
      --bg:#0f1320; --fg:#e9eef7; --muted:#a8b0c3;
      --card:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      --stroke:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,Arial,sans-serif
    }
    .wrap{max-width:980px;margin:0 auto;padding:20px}

    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    h1{margin:8px 0 10px;font-size:clamp(24px,6vw,36px);line-height:1.1}

    .btn{
      display:inline-block;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06);
      color:var(--fg); text-decoration:none; transition:.12s ease; white-space:nowrap;
      cursor:pointer;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px}

    select, input{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--fg);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
    }
    input{min-width:220px}
    input:focus, select:focus{border-color:rgba(255,255,255,.22)}

    /* Сетка превью */
    .grid{
      display:grid; gap:12px; margin:14px 0 18px;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    }
    .card{
      border:1px solid var(--stroke); border-radius:14px; overflow:hidden;
      background:var(--card);
      transition:transform .1s ease, box-shadow .12s ease;
      color:inherit;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .thumb{display:block;width:100%;aspect-ratio:4/3;object-fit:cover}
    .meta{padding:10px 12px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:8px}
    .meta b{color:var(--fg);font-weight:600}

    .meta .sub{opacity:.85}
    .more-wrap{display:flex;justify-content:center;margin:6px 0 26px}
    .empty{opacity:.8;color:var(--muted);text-align:center;margin:26px 0}
    .hint{opacity:.75;color:var(--muted);font-size:13px;margin-top:6px}

    /* Лайтбокс на <dialog> */
    dialog#lightbox{
      border:none; padding:0; background:transparent; width:100%;
    }
    dialog#lightbox::backdrop{background:rgba(0,0,0,.6)}
    .lightbox-inner{
      max-width:min(96vw,1100px); margin:4vh auto; background:#0c1120;
      border:1px solid var(--stroke); border-radius:14px; overflow:hidden;
    }
    .lightbox-media{background:#000}
    .lightbox-media img{display:block;max-height:70vh; width:100%; object-fit:contain}
    .lightbox-meta{
      padding:12px 14px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      flex-wrap:wrap;
    }
    .lightbox-meta .left{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted)
    }
    .lightbox-meta b{color:var(--fg)}
    .lightbox-close{margin-left:auto}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Зал славы</h1>
      <a class="btn" href="/">На главную</a>
    </header>

    <div class="controls">
      <label>
        <span style="opacity:.8;margin-right:6px">Год:</span>
        <select id="yearFilter">
          <option value="all">Все</option>
        </select>
      </label>

      <label>
        <span style="opacity:.8;margin-right:6px">Игрок:</span>
        <select id="playerFilter">
          <option value="all">Все</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;gap:8px">
        <span style="opacity:.8">Поиск:</span>
        <input id="q" placeholder="ник / противник / тег / автор..." />
      </label>

      <button id="sortBtn" class="btn" type="button">Сначала новые</button>
    </div>

    <div class="hint" id="stats"></div>

    <div id="grid" class="grid"></div>

    <div id="empty" class="empty" hidden>Пока пусто. Скоро тут будут ваши лучшие победы!</div>

    <div class="more-wrap">
      <button id="moreBtn" class="btn" type="button">Показать ещё</button>
    </div>
  </div>

  <!-- Лайтбокс -->
  <dialog id="lightbox">
    <div class="lightbox-inner">
      <div class="lightbox-media"><img id="lbImg" alt=""></div>
      <div class="lightbox-meta">
        <div class="left">
          <b id="lbPlayer"></b>
          <span id="lbOpp"></span>
          <span id="lbTrophies"></span>
          <span id="lbDate"></span>
          <span id="lbAuthor"></span>
          <span id="lbTags"></span>
        </div>
        <a id="lbOpen" class="btn" href="#" target="_blank" rel="noopener">Открыть оригинал</a>
        <button class="btn lightbox-close" type="button" onclick="document.getElementById('lightbox').close()">Закрыть</button>
      </div>
    </div>
  </dialog>

  <script>
    // ====== элементы ======
    const grid = document.getElementById('grid');
    const moreBtn = document.getElementById('moreBtn');
    const emptyEl = document.getElementById('empty');
    const yearSelect = document.getElementById('yearFilter');
    const playerSelect = document.getElementById('playerFilter');
    const sortBtn = document.getElementById('sortBtn');
    const qInput = document.getElementById('q');
    const statsEl = document.getElementById('stats');

    // ====== состояние ======
    let ITEMS = [];
    let page = 0;
    const PAGE_SIZE = 12;
    let sortDesc = true; // новые сверху
    let currentYear = 'all';
    let currentPlayer = 'all';
    let q = '';

    // ====== утилиты ======
    function norm(s){ return (s||"").toLowerCase().trim(); }

    function uniqueYears(items){
      const set = new Set(items.map(i => (i.date||"").slice(0,4)).filter(Boolean));
      return Array.from(set).sort((a,b)=>b.localeCompare(a));
    }
    function uniquePlayers(items){
      const set = new Set(items.map(i => (i.player||"").trim()).filter(Boolean));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
    }

    function applyFilters(){
      let arr = [...ITEMS];

      // год
      if(currentYear !== 'all'){
        arr = arr.filter(i => (i.date||"").startsWith(currentYear));
      }

      // игрок
      if(currentPlayer !== 'all'){
        arr = arr.filter(i => (i.player||"") === currentPlayer);
      }

      // поиск по player/opponent/author/tags
      if(q){
        const qq = norm(q);
        arr = arr.filter(i => {
          const hay = [
            i.player, i.opponent, i.author,
            ...(i.tags||[])
          ].map(norm).join(" ");
          return hay.includes(qq);
        });
      }

      // сортировка по дате
      arr.sort((a,b) => sortDesc
        ? (b.date||"").localeCompare(a.date||"")
        : (a.date||"").localeCompare(b.date||"")
      );

      return arr;
    }

    function setStats(total, filtered){
      if(total === 0){
        statsEl.textContent = '';
        return;
      }
      const parts = [];
      parts.push(`Всего: ${total}`);
      parts.push(`Показано по фильтрам: ${filtered}`);
      if(currentPlayer !== 'all') parts.push(`Игрок: ${currentPlayer}`);
      if(currentYear !== 'all') parts.push(`Год: ${currentYear}`);
      if(q) parts.push(`Поиск: “${q}”`);
      statsEl.textContent = parts.join(' • ');
    }

    // ====== рендер ======
    function render(reset=false){
      const all = applyFilters();
      setStats(ITEMS.length, all.length);

      if(reset){ grid.innerHTML = ""; page = 0; }

      const start = page*PAGE_SIZE;
      const slice = all.slice(start, start+PAGE_SIZE);

      if(reset && all.length===0){
        emptyEl.hidden = false;
        moreBtn.style.display='none';
        return;
      } else {
        emptyEl.hidden = true;
      }

      for(const item of slice){
        const card = document.createElement('a');
        card.className = 'card';
        card.href = item.src || '#';
        card.addEventListener('click', (e)=>{ e.preventDefault(); openLightbox(item); });

        const img = document.createElement('img');
        img.className = 'thumb';
        img.loading = 'lazy';
        img.src = item.thumb || item.src;
        img.alt = `${item.player || 'Игрок'} vs ${item.opponent || ''}`.trim();

        const meta = document.createElement('div');
        meta.className = 'meta';

        const left = document.createElement('div');
        const opp = item.opponent ? ` <span class="sub">vs ${item.opponent}</span>` : '';
        left.innerHTML = `<b>${item.player||'Игрок'}</b>${opp}`;

        const right = document.createElement('div');
        right.textContent = item.date || '';

        meta.append(left, right);
        card.append(img, meta);
        grid.append(card);
      }

      page++;
      moreBtn.style.display = (start + slice.length >= all.length) ? 'none' : '';
    }

    // ====== лайтбокс ======
    function openLightbox(item){
      const dlg = document.getElementById('lightbox');
      document.getElementById('lbImg').src             = item.src || '';
      document.getElementById('lbPlayer').textContent  = item.player || '';
      document.getElementById('lbOpp').textContent     = item.opponent ? `против ${item.opponent}` : '';
      document.getElementById('lbTrophies').textContent= item.trophies ? `• ${item.trophies} куб.` : '';
      document.getElementById('lbDate').textContent    = item.date ? `• ${item.date}` : '';
      document.getElementById('lbAuthor').textContent  = item.author ? `• ${item.author}` : '';
      document.getElementById('lbTags').textContent    = (item.tags && item.tags.length) ? `• #${item.tags.join(' #')}` : '';
      document.getElementById('lbOpen').href           = item.src || '#';
      dlg.showModal();
    }

    // Закрытие по клику на фон
    document.getElementById('lightbox').addEventListener('click', e=>{
      const dlg = e.currentTarget;
      const rect = dlg.querySelector('.lightbox-inner').getBoundingClientRect();
      const inDialog =
        e.clientX >= rect.left && e.clientX <= rect.right &&
        e.clientY >= rect.top  && e.clientY <= rect.bottom;
      if(!inDialog) dlg.close();
    });

    // ====== загрузка данных ======
    async function init(){
      try{
        const res = await fetch('/data/hof.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('Не удалось загрузить /data/hof.json');
        const data = await res.json();

        // минимальная нормализация
        ITEMS = Array.isArray(data) ? data.filter(x => x && x.src) : [];

        // заполнить годы
        for(const y of uniqueYears(ITEMS)){
          const o = document.createElement('option');
          o.value = o.textContent = y;
          yearSelect.appendChild(o);
        }

        // заполнить игроков
        for(const p of uniquePlayers(ITEMS)){
          const o = document.createElement('option');
          o.value = o.textContent = p;
          playerSelect.appendChild(o);
        }

        // обработчики
        yearSelect.addEventListener('change', e => { currentYear = e.target.value; render(true); });
        playerSelect.addEventListener('change', e => { currentPlayer = e.target.value; render(true); });
        sortBtn.addEventListener('click', ()=>{
          sortDesc = !sortDesc;
          sortBtn.textContent = sortDesc ? "Сначала новые" : "Сначала старые";
          render(true);
        });
        moreBtn.addEventListener('click', ()=> render(false));
        qInput.addEventListener('input', e => { q = e.target.value; render(true); });

        // первый рендер
        render(true);
      } catch(err){
        console.error(err);
        statsEl.textContent = 'Ошибка загрузки данных. Проверь /public/data/hof.json';
        emptyEl.hidden = false;
        moreBtn.style.display = 'none';
      }
    }

    init();
  </script>
</body>
</html>
